#!/usr/bin/env python3
"""
üó°Ô∏è SICARIUS EXPLOIT VERIFIER
Part of CenturionCLI (Cohors Ferrata)

Executes browser-based proof-of-concept attacks using Playwright.
Verifies vulnerabilities by simulating user interaction.
"""

import argparse
import sys
import json
from datetime import datetime, timezone
from playwright.sync_api import sync_playwright

def banner():
    print("""
    üó°Ô∏è  SICARIUS EXPLOIT VERIFIER v1.0
    Centurion Legion | Cohors Ferrata
    """)

def run_exploit(url, inputs, submit_selector, success_condition, screenshot_path):
    report = {
        "timestamp": datetime.now(timezone.utc).isoformat(),
        "url": url,
        "success": False,
        "logs": []
    }

    try:
        with sync_playwright() as p:
            browser = p.chromium.launch(headless=True)
            context = browser.new_context(ignore_https_errors=True)
            page = context.new_page()

            report['logs'].append(f"Navigating to {url}...")
            page.goto(url, timeout=30000)
            
            # Fill inputs
            # Format: selector=value,selector=value
            for item in inputs:
                if '=' in item:
                    sel, val = item.split('=', 1)
                    report['logs'].append(f"Filling '{sel}' with '{val}'")
                    page.fill(sel, val)
            
            # Submit
            if submit_selector:
                report['logs'].append(f"Clicking '{submit_selector}'")
                page.click(submit_selector)
                page.wait_for_load_state('networkidle')
            
            # Check success condition
            # Format: type:value (e.g., text:Welcome, url:dashboard)
            cond_type, cond_val = success_condition.split(':', 1)
            
            if cond_type == 'text':
                found = page.get_by_text(cond_val).count() > 0
                report['success'] = found
                report['logs'].append(f"Check text '{cond_val}': {'FOUND' if found else 'NOT FOUND'}")
            
            elif cond_type == 'url':
                current_url = page.url
                found = cond_val in current_url
                report['success'] = found
                report['logs'].append(f"Check URL contains '{cond_val}': {current_url} ({'MATCH' if found else 'NO MATCH'})")

            # Proof
            if screenshot_path:
                page.screenshot(path=screenshot_path)
                report['screenshot'] = screenshot_path
                report['logs'].append(f"Screenshot saved to {screenshot_path}")

            browser.close()

    except Exception as e:
        report['error'] = str(e)
        report['logs'].append(f"CRITICAL ERROR: {e}")

    return report

def main():
    parser = argparse.ArgumentParser(description="Sicarius Exploit Verifier")
    parser.add_argument("url", help="Target URL")
    parser.add_argument("--input", action='append', help="Input field payload (selector=value)", required=True)
    parser.add_argument("--submit", help="Submit button selector", required=True)
    parser.add_argument("--condition", help="Success condition (text:String or url:String)", required=True)
    parser.add_argument("--output", help="Screenshot path")
    parser.add_argument("--json", action="store_true", help="Output JSON only")
    
    args = parser.parse_args()

    if not args.json:
        banner()
        print(f"üéØ Target: {args.url}")

    result = run_exploit(
        args.url, 
        args.input, 
        args.submit, 
        args.condition, 
        args.output
    )

    if args.json:
        print(json.dumps(result, indent=2))
    else:
        status = "‚úÖ VULNERABLE (Success)" if result['success'] else "‚ùå FAILED (Safe)"
        print(f"\nResult: {status}")
        print("Logs:")
        for log in result['logs']:
            print(f"  - {log}")
        if 'error' in result:
            print(f"Error: {result['error']}")

if __name__ == "__main__":
    main()
